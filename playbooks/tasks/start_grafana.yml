- name: Start grafana
  hosts: "{{ variable_host }}"
  gather_facts: false
  tasks:
    - name: Include secret variables for grafana username and password
      include_vars: "{{inventory_dir}}/group_vars/secrets.yml"

    - name: Creates grafana data dir
      file:
        path: "{{grafana_data_dir}}"
        state: directory

    - name: Creates grafana conf dir
      file:
        path: "{{grafana_conf_dir}}"
        state: directory

    - name: Archive local_grafana_conf_dir dir to prepare for upload
      archive:
        path: "{{local_grafana_conf_dir}}/*"
        dest: "{{local_grafana_conf_archive}}"
      delegate_to: localhost

    - name: Upload grafana conf to remote
      unarchive:
        src: "{{ local_grafana_conf_archive }}"
        dest: "{{ grafana_conf_dir }}"

    - name: Remove {{local_grafana_conf_archive}} archive after upload
      file:
        path: "{{ local_grafana_conf_archive }}"
        state: absent
      delegate_to: localhost

    - name: Modify permissions to match user-group inside docker image
      shell: chown -R "{{ ansible_user }}" "{{ grafana_data_dir }}" && chown -R "{{ ansible_user }}" "{{ grafana_conf_dir }}"
      become: true

    - name: Start grafana container
      docker_container:
        name: "{{ grafana_container_name }}"
        state: started
        image: "{{ grafana_image_name }}"
        pull: true
        restart_policy: unless-stopped
        memory_swappiness: 0
        kernel_memory: "{{grafana_kernel_memory}}"
        network_mode: host
        restart: "{{ grafana_require_restart | default(false) }}"
        log_options: "{{ common_log_options }}"
        log_driver: "{{ common_log_driver }}"
        volumes: "{{grafana_volumes}}"
        memory: "{{grafana_memory}}"
        memory_swap: "{{grafana_memory}}"
        command: "{{ grafana_start_args }}"
        env: "{{ grafana_env | default({}) }}"
        user: "{{ grafana_user_id }}"

    - name: Register grafana metrics to prometheus
      copy:
        dest: "{{ prometheus_file_sd_dir }}/grafana.yml"
        content: |
          - labels:
              instance: grafana
            targets:
            - localhost:3000
